
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Putting everything together &#8212; NiPreps</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.e7340bb3dbd8dde6db86f25597f54a1b.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="The extra mile" href="../extra/nifti.html" />
    <link rel="prev" title="Image registration (spatial alignment)" href="registration.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  
  <h1 class="site-logo" id="site-title">NiPreps</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../welcome.html">
   Welcome!
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  preparation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../preparation/step0.html">
   Before we start: How to follow this tutorial
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  nipreps
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../nipreps/nipreps.html">
   NeuroImaging PREProcessing toolS (NiPreps)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../nipreps/dmriprep.html">
   About dMRIPrep
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  tutorial
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   The problem of head-motion in dMRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="data.html">
   Introduction to dMRI data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="models.html">
   Diffusion modeling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="registration.html">
   Image registration (spatial alignment)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Putting everything together
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  extra
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/nifti.html">
   The extra mile
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../extra/community_development.html">
   Community development
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        <a class="dropdown-buttons"
            href="../_sources/tutorial/solution.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download notebook file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/tutorial/solution.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/nipreps/nipreps-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/nipreps/nipreps-book/issues/new?title=Issue%20on%20page%20%2Ftutorial/solution.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/nipreps/nipreps-book/main?urlpath=lab/tree/docs/tutorial/solution.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-s-next-testing">
   What’s next? - Testing!
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#and-after-testing-validation">
   And after testing? - Validation!
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="putting-everything-together">
<h1>Putting everything together<a class="headerlink" href="#putting-everything-together" title="Permalink to this headline">¶</a></h1>
<p>Once we have finalized the main components of the solution, it is time for integration.
We now want to iterate over all the <em>LOGO</em> partitions of the dataset, generate a synthetic reference through the model of choice, and finally estimate the misalignment between the left-out gradient and the synthetic reference.
This solution, must also abide by the API we have envisioned.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Complete the code snipet below to integrate the different components into the final solution to the dMRI head-motion problem.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EddyMotionEstimator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Estimates rigid-body head-motion and distortions derived from eddy-currents.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="n">dwdata</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">align_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;b0&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate head-motion and Eddy currents.</span>

<span class="sd">        &lt;please write a descriptive documentation of the function here&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">align_kwargs</span> <span class="o">=</span> <span class="n">align_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">brainmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">brainmask</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">bzero</span>

        <span class="k">for</span> <span class="n">i_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dwdata</span><span class="p">)):</span>
                <span class="c1"># run a original-to-synthetic affine registration</span>
                <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
                    <span class="c1"># Invoke `dwdata.logo_split()` on an index.</span>
                    <span class="n">data_train</span><span class="p">,</span> <span class="n">data_test</span> <span class="o">=</span> <span class="o">...</span>

                    <span class="c1"># Factory creates the appropriate model and pipes arguments</span>
                    <span class="n">dwmodel</span> <span class="o">=</span> <span class="o">...</span>

                    <span class="c1"># fit the model</span>


                    <span class="c1"># generate a synthetic dw volume for the test gradient</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="o">...</span>

                    <span class="c1"># Write arrays in memory to harddisk as NIfTI files</span>
                    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
                    <span class="n">moving</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="s2">&quot;moving.nii.gz&quot;</span>
                    <span class="n">fixed</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="s2">&quot;fixed.nii.gz&quot;</span>
                    <span class="n">_to_nifti</span><span class="p">(</span><span class="n">data_test</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moving</span><span class="p">)</span>
                    <span class="n">_to_nifti</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>

                    <span class="c1"># Prepare ANTs&#39; antsRegistration via NiPype</span>
                    <span class="n">registration</span> <span class="o">=</span> <span class="n">Registration</span><span class="p">(</span>
                        <span class="n">fixed_image</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">fixed</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>
                        <span class="n">moving_image</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">moving</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>
                        <span class="o">**</span><span class="n">align_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># execute ants command line</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">))</span><span class="o">.</span><span class="n">outputs</span>

                    <span class="c1"># read output transform</span>
                    <span class="n">xform</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">itk</span><span class="o">.</span><span class="n">ITKLinearTransform</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">forward_transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># update</span>
                <span class="n">dwdata</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xform</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">em_affines</span>
</pre></div>
</div>
<p><strong>Solution</strong></p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">EddyMotionEstimator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Estimates rigid-body head-motion and distortions derived from eddy-currents.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span>
        <span class="n">dwdata</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">n_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">align_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="s2">&quot;b0&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate head-motion and Eddy currents.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dwdata : :obj:`~eddymotion.dmri.DWI`</span>
<span class="sd">            The target DWI dataset, represented by this tool&#39;s internal</span>
<span class="sd">            type. The object is used in-place, and will contain the estimated</span>
<span class="sd">            parameters in its ``em_affines`` property, as well as the rotated</span>
<span class="sd">            *b*-vectors within its ``gradients`` property.</span>
<span class="sd">        n_iter : :obj:`int`</span>
<span class="sd">            Number of iterations this particular model is going to be repeated.</span>
<span class="sd">        align_kwargs : :obj:`dict`</span>
<span class="sd">            Parameters to configure the image registration process.</span>
<span class="sd">        model : :obj:`str`</span>
<span class="sd">            Selects the diffusion model that will generate the registration target</span>
<span class="sd">            corresponding to each gradient map.</span>
<span class="sd">            See :obj:`~eddymotion.model.ModelFactory` for allowed models (and corresponding</span>
<span class="sd">            keywords).</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        affines : :obj:`list` of :obj:`numpy.ndarray`</span>
<span class="sd">            A list of :math:`4 \times 4` affine matrices encoding the estimated</span>
<span class="sd">            parameters of the deformations caused by head-motion and eddy-currents.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">align_kwargs</span> <span class="o">=</span> <span class="n">align_kwargs</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">brainmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">brainmask</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;S0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">bzero</span>

        <span class="k">for</span> <span class="n">i_iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dwdata</span><span class="p">)):</span>
                <span class="c1"># run a original-to-synthetic affine registration</span>
                <span class="k">with</span> <span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmpdir</span><span class="p">:</span>
                    <span class="c1"># Invoke `dwdata.logo_split()` on an index.</span>
                    <span class="n">data_train</span><span class="p">,</span> <span class="n">data_test</span> <span class="o">=</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">logo_split</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">with_b0</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># Factory creates the appropriate model and pipes arguments</span>
                    <span class="n">dwmodel</span> <span class="o">=</span> <span class="n">ModelFactory</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
                        <span class="n">gtab</span><span class="o">=</span><span class="n">data_train</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                    <span class="p">)</span>

                    <span class="c1"># fit the model</span>
                    <span class="n">dwmodel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># generate a synthetic dw volume for the test gradient</span>
                    <span class="n">predicted</span> <span class="o">=</span> <span class="n">dwmodel</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_test</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Write arrays in memory to harddisk as NIfTI files</span>
                    <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">)</span>
                    <span class="n">moving</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="s2">&quot;moving.nii.gz&quot;</span>
                    <span class="n">fixed</span> <span class="o">=</span> <span class="n">tmpdir</span> <span class="o">/</span> <span class="s2">&quot;fixed.nii.gz&quot;</span>
                    <span class="n">_to_nifti</span><span class="p">(</span><span class="n">data_test</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">moving</span><span class="p">)</span>
                    <span class="n">_to_nifti</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>

                    <span class="c1"># Prepare ANTs&#39; antsRegistration via NiPype</span>
                    <span class="n">registration</span> <span class="o">=</span> <span class="n">Registration</span><span class="p">(</span>
                        <span class="n">fixed_image</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">fixed</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>
                        <span class="n">moving_image</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">moving</span><span class="o">.</span><span class="n">absolute</span><span class="p">()),</span>
                        <span class="o">**</span><span class="n">align_kwargs</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="c1"># execute ants command line</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">registration</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">))</span><span class="o">.</span><span class="n">outputs</span>

                    <span class="c1"># read output transform</span>
                    <span class="n">xform</span> <span class="o">=</span> <span class="n">nt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">itk</span><span class="o">.</span><span class="n">ITKLinearTransform</span><span class="o">.</span><span class="n">from_filename</span><span class="p">(</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">forward_transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="c1"># update</span>
                <span class="n">dwdata</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">xform</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dwdata</span><span class="o">.</span><span class="n">em_affines</span>
</pre></div>
</div>
</div>
</div>
<p>The above code allows us to use our estimator as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">eddymotion.estimator</span> <span class="kn">import</span> <span class="n">EddyMotionEstimator</span>

<span class="n">estimated_affines</span> <span class="o">=</span> <span class="n">EddyMotionEstimator</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">dmri_dataset</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&quot;b0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="what-s-next-testing">
<h2>What’s next? - Testing!<a class="headerlink" href="#what-s-next-testing" title="Permalink to this headline">¶</a></h2>
<p>Once we have our first implementation functional, we should think of some unit-tests for our code.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Write a unit test for the <code class="docutils literal notranslate"><span class="pre">TrivialB0Model</span></code>.
This test would just make sure that, regardless of the particular partition of the input dataset, a <em>b=0</em> map is always returned.</p>
</div>
<p><strong>Solution</strong>: in this solution, we are using <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to integrate the test into a higher-level test suite.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;split_index&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">test_TrivialB0Model</span><span class="p">(</span><span class="n">split_index</span><span class="p">,</span> <span class="n">dmri_dataset</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">TrivialB0Model</span><span class="p">(</span>
        <span class="n">dmri_dataset</span><span class="o">.</span><span class="n">gradients</span><span class="p">,</span>
        <span class="n">S0</span><span class="o">=</span><span class="n">dmri_dataset</span><span class="o">.</span><span class="n">bzero</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data_train</span><span class="p">,</span> <span class="n">data_test</span> <span class="o">=</span> <span class="n">dmri_dataset</span><span class="o">.</span><span class="n">logo_split</span><span class="p">(</span><span class="n">split_index</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data_test</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dmri_dataset</span><span class="o">.</span><span class="n">bzero</span> <span class="o">==</span> <span class="n">predicted</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="and-after-testing-validation">
<h2>And after testing? - Validation!<a class="headerlink" href="#and-after-testing-validation" title="Permalink to this headline">¶</a></h2>
<p>Once we have a sufficient portion of our code <em>covered</em> by unit-tests, then we would add some <em>integration</em> tests that give us confidence that our bullet-proof individual components also work together.
Only after we have both steps secure, we can run benchmarks and evaluations from which we learn whether our solution works, and characterize its limitations.</p>
<p>The main strategy to validate this software would entail finding/acquiring a special dataset where motion is not present or extremely low, in which we <em>introduce</em> a known head-motion pattern with which we are going to challenge our estimator.
Some ideas to achieve this are:</p>
<ul class="simple">
<li><p>a dataset acquired with special sequences that can do prospective motion correction, or</p></li>
<li><p>a dataset that has been acquired under very controlled settings, with an extremely collaborative participant who was also wearing a personalized mold, or</p></li>
<li><p>a fully synthetic dataset such as the Fiber Box, or</p></li>
<li><p>a fully synthetic dataset containing a repeated <em>b=0</em> image (this evaluation would be limited to work with the <code class="docutils literal notranslate"><span class="pre">TrivialB0Model</span></code>, for instance).</p></li>
</ul>
<p><em><strong>Please head to <a class="reference external" href="https://github.com/nipreps/EddyMotionCorrection">the GitHub repository</a> and share your ideas with us! We are welcoming new contributors!</strong></em></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./tutorial"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="registration.html" title="previous page">Image registration (spatial alignment)</a>
    <a class='right-next' id="next-link" href="../extra/nifti.html" title="next page">The extra mile</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By The NiPreps developers<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>